name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27'

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get --only prod

      - name: Compile project
        run: MIX_ENV=prod mix compile

      - name: Build hex archive
        run: MIX_ENV=prod mix archive.build

      - name: Verify artifacts
        run: |
          ls -lh metastatic-*.ez
          echo "Archive size: $(du -h metastatic-*.ez | cut -f1)"

      - name: Generate checksums
        run: |
          sha256sum metastatic-*.ez > metastatic-archive.sha256
          cat metastatic-archive.sha256

      - name: Create release notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## Installation

          ### Hex Archive (Global Mix Tasks)

          Install directly from Hex:

          ```bash
          mix archive.install hex metastatic
          ```

          Or download and install the archive:

          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/metastatic-${{ steps.version.outputs.version }}.ez
          mix archive.install metastatic-${{ steps.version.outputs.version }}.ez
          ```

          ### Mix Dependency (Recommended)

          Add to your `mix.exs`:

          ```elixir
          def deps do
            [
              {:metastatic, "~> ${{ steps.version.outputs.version }}"}
            ]
          end
          ```

          Then run:

          ```bash
          mix deps.get
          ```

          ## Usage

          ### As a Library

          ```elixir
          alias Metastatic.{AST, Document, Adapter}
          alias Metastatic.Adapters.{Elixir, Python}

          # Parse Elixir code
          {:ok, doc} = Adapter.abstract(Elixir, "x + 5", :elixir)

          # Parse Python code
          {:ok, doc} = Adapter.abstract(Python, "x + 5", :python)

          # Both produce equivalent MetaAST!
          ```

          ### CLI Tools

          With hex archive or as dependency:

          ```bash
          # Cross-language translation
          mix metastatic.translate --from python --to elixir hello.py

          # AST inspection
          mix metastatic.inspect hello.py

          # Analyze MetaAST metrics
          mix metastatic.analyze hello.py

          # Check semantic equivalence
          mix metastatic.validate_equivalence hello.py hello.ex

          # Purity analysis
          mix metastatic.purity_check my_file.py

          # Complexity metrics
          mix metastatic.complexity my_file.ex
          ```

          ## What's Changed

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for detailed changes.

          ## Verification

          Verify the downloaded files using SHA256 checksums:

          ```bash
          sha256sum -c metastatic-archive.sha256
          ```

          ## Documentation

          - [Getting Started Guide](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/GETTING_STARTED.md)
          - [Theoretical Foundations](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/THEORETICAL_FOUNDATIONS.md)
          - [Supplemental Modules](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/SUPPLEMENTAL_MODULES.md)
          - [API Documentation](https://hexdocs.pm/metastatic)
          - [Examples](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/examples)

          ## Supported Languages

          - Elixir (all 3 layers: Core, Extended, Native)
          - Erlang (all 3 layers: Core, Extended, Native)
          - Python (all 3 layers: Core, Extended, Native)

          More languages coming soon!
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            metastatic-*.ez
            metastatic-archive.sha256
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'dev') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-hex:
    name: Publish to Hex.pm
    runs-on: ubuntu-latest
    needs: build
    if: "!contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') && !contains(github.ref, 'dev')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27'

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Publish to Hex
        run: mix hex.publish --yes
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [build, publish-hex]
    if: always()
    steps:
      - name: Check release status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build failed!"
            exit 1
          fi
          
          if [ "${{ needs.publish-hex.result }}" == "skipped" ]; then
            echo "Hex publishing skipped (pre-release)"
          elif [ "${{ needs.publish-hex.result }}" != "success" ]; then
            echo "Hex publishing failed!"
            exit 1
          fi
          
          echo "Release completed successfully!"
          echo "Download artifacts from: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
